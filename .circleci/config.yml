version: 2.1

orbs:
    - terraform: circleci/terraform@1.2.0

jobs:
    dependencies-zip-generation:
        docker:
            - image: node:12.20.1-stretch-slim
        steps:
            - checkout
            - run:
                name: install node modules
                command: npm install
            - run:
                name: Install zip
                command: |
                    apt-get update
                    apt-get install zip -y
            - run:
                name: compile
                command: npm run compile
            - run:
                name: zip and save source code
                command: zip -r function.zip built/* node_modules
            - persist_to_workspace:
                root: ./
                paths: 
                    - function.zip
    deploy_infrastructure:
        - terraform/fmt:
            checkout: true
            context: terraform
        - terraform/validate:
            checkout: true
            context: terraform
            requires:
                - terraform/fmt
        - terraform/plan:
            checkout: true
            context: terraform
            persist-workspace: true
            requires:
                - terraform/validate
        - terraform/apply:
            attach-workspace: true
            context: terraform
            filters:
                branches:
                only: master
            requires:
                - terraform/plan
workflows:
    main:
        jobs:
            - dependencies-zip-generation
            - deploy_infrastructure:
                context: 
                    - AWSContext
                requires: 
                    - dependencies-zip-generation
